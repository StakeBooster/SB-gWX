# Распределение наград пула

У пула есть **айдишник клейма**, с каждым новым клеймом наград, этот айдишник увеличивается.

Мы храним и с каждым новым клеймом обновляем общую склеймленную пропорцию пула.

Это **колл-во полученных наград** / **общее колл-во застейканых токенов на данный период** = **колл-во наградных токенов на единицу застейканого токена**

Пример:

1. Пул делает самый первый клейм наград, на данный момент имеем
    
    айдишник периода пула = 0
    
    пропорция склеймленных наград = 0
    
    получили награды = 1500 / берем как пример
    
    было застейкано токенов 345 000 / берем как пример
    
    1. Вычисляем пропорцию за период: 1500 / 345000 = 0,00435
    2. Обновляем отслеживаемые данные:
        1. Увеличиваем айдишник клейма на 1: 1
        2. Записываем новую пропорцию: текущая пропорция(0) + 0,00435 = 0,00435
2. Пул делает второй клейм ревардов, на данный момент имеем:
    
    айдишник периода пула = 1
    
    пропорция склеймленных наград = 0,00435
    
    получили награды = 120 / берем как пример
    
    было застейкано токенов 22 300 / берем как пример
    
    1. Вычисляем пропорцию за период: 120 / 22 300 = 0,00538
    2. Обновляем отслеживаемые данные:
        1. Увеличиваем айдишник клейма на 1: 2
        2. Записываем новую пропорцию: текущая пропорция(0,00435) + 0,00538 = 0,00973

## Пользователь

> *Для пользователя у нас есть одно ограничение: Если у него есть не склеймленные награды за предыдущие периоды клейма пула, он не может **увеличивать** или **уменьшать** сумму своего стейка, пока не заберет полученные им награды за предыдущие периоды.*
> 

Чтобы правильно расчитывать награды, положенные пользователю, мы также трекаем его личную пропорцию уже склеймленных наград с пула.

При самом первом стейке пользователя, мы в эту пропорцию просто записываем текущее значение общей пропорции пула, так как это пул склеймил без участия пользователя и наш пользователь на нее претендовать не может.

Далее, пользователь может не клеймить свои награды сколько угодно периодов, главное, чтобы сумма его стейка оставалась неизменной.

### Пользователь хочет склеймить награды

Когда пользователь хочет склеймить награды, мы делаем следующее:

1. Берем текущую общую пропорцию пула (текущее колл-во ревардных токенов на единицу застейканого токена) и отнимаем от нее пропорцию по пользователю, тем самым выясняем пропорцию, которая полагается пользователю
2. Умножаем эту пропорцию на колл-во застейканых пользователем токенов, чтобы узнать колл-во ревардных токенов, которые полагаются ему на текущий момент
3. Обновляем пропорцию по пользователю (прибавляем к текущей пропорции по пользователю, пропорцию, которая полагалась ему на текущий момент(пункт 1))
4. Выставляем пользователю айдишник последнего клейма = текущий айди клейма пула
5. Высылаем сумму токенов, полученную в пункте 2, на адрес пользователя
